## Dev Log – 2025-08-12 (Tue, JST)

### Done
- OpenAPIドラフト整備（YAMLの `description` に `{}` を含む箇所のクォート対応）。
- Redocドキュメント出力・プレビュー手順確立（`@redocly/cli build-docs`／`redoc-cli serve`、空の `favicon.ico` 対策）。
- oapi-codegenのタグ/Goバージョン罠を回避し、**Go 1.23 + oapi-codegen@main + Gin** で再構築。
- Ginサーバを生成コードベースで起動。`openapi3` のバリデータ導入、**開発用の簡易Auth（Bearerヘッダ必須）** を実装。
- ルーティングに **`/v1` BaseURL** を適用し、`GET /v1/dashboard/now` が **200** で `{"groups":[]}` を返すところまで確認。

### Decisions
- 言語／FW：**Go 1.23 + Gin**（oapi-codegen は **新リポジトリ@main** を使用）。
- リクエスト検証：`kin-openapi` を読み込んで `OapiRequestValidator` を適用。
- 認証：本番までの間は **開発用Auth**（`Authorization: Bearer ...` があれば通す）。本実装は後日JWT検証に差し替え。
- ルーティング：OpenAPIの `servers.url` はコード生成に自動反映されないため、**BaseURL `/v1` をコード側で付与**。
- まずはDBなしで進め、**メモリストア**でMVPを構築 → 後でPostgreSQLへ移行。

### Next
- メモリストアを仕上げ、以下のハンドラを **200実装** に差し替え：
  - `POST /v1/resource-groups`（作成）
  - `GET /v1/resource-groups`（一覧）
  - `POST /v1/sessions`（開始）
  - `PATCH /v1/sessions/{id}/end`（終了）
  - `GET /v1/sessions`（簡易フィルタ付き）
  - `GET /v1/dashboard/now`（アクティブ数・待ち時間の算出）
- `package.json` / `Makefile` に以下の定番タスクを登録：`api:docs`、`api:gen`、`run`。
- Spectralルールを導入（`spectral:oas`）し、`npm run api:lint` を安定化。
- エンドポイントごとの簡易E2Eスクリプト（`test.http` または `curl` セット）を整備。

### Notes
- `openapi.yaml` はパスに空白があるため **常にクォート**（`"./openapi/openapi.yaml"`）を意識。
- `redoc-cli serve` は `favicon.ico` が無いと落ちる挙動あり → `openapi/favicon.ico` を空でも配置。
- oapi-codegen の一部タグは `go.mod` の `go x.y.z` 表記が壊れている版があるため、**@main 固定が安定**。
- `servers.url` はドキュメント用途。**実配信のパスはコードで決める**（今回は `/v1`）。

### Commands (repro)
- API Docs  
  `npx @redocly/cli@latest build-docs "./openapi/openapi.yaml" -o "./web/public/api.html"`
- サーバ生成（types + gin）  
  `go run github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@main -generate types,gin -package api -o backend/internal/api/openapi.gen.go ./openapi/openapi.yaml`
- 起動（backend/ にて）  
  `go run ./cmd/server`

### Open Questions
- 待ち時間推定のロジック（固定10分 → 移動平均 or 直近分位点？）
- 予約機能の不要仮説の検証方法（導線とUX、混雑時間帯の提示で十分か）。
- 認証：OWNER/STAFF/MEMBER の最小要件・権限の切り分け。
